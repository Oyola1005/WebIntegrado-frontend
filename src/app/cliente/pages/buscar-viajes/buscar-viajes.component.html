<!-- HERO principal: la imagen es el cuadro -->
<section class="hero-bus">
  <div class="hero-overlay">
    <div class="hero-container">
      <h1 class="hero-title">Reserva tu viaje con Transporte Miranda</h1>

      <!-- Tarjeta de b√∫squeda -->
      <form [formGroup]="form" (ngSubmit)="buscar()" class="search-card">
        <!-- ORIGEN -->
        <div class="search-field">
          <label class="field-label">Desde</label>
          <div class="field-input-wrapper">
            <span class="field-icon">üìç</span>
            <select class="field-input" formControlName="origen">
              <option value="" disabled selected>Seleccionar origen</option>
              <option value="Lima">Lima</option>
              <option value="Chimbote">Chimbote</option>
            </select>
          </div>
        </div>

        <!-- DESTINO -->
        <div class="search-field">
          <label class="field-label">Hasta</label>
          <div class="field-input-wrapper">
            <span class="field-icon">üìç</span>
            <select class="field-input" formControlName="destino">
              <option value="" disabled selected>Seleccionar destino</option>
              <option value="Chimbote">Chimbote</option>
              <option value="Lima">Lima</option>
            </select>
          </div>
        </div>

        <!-- FECHA IDA -->
        <div class="search-field">
          <label class="field-label">Fecha de ida</label>
          <div class="field-input-wrapper">
            <span class="field-icon">üìÖ</span>
            <input
              type="date"
              class="field-input"
              formControlName="fechaIda"
              [min]="todayStr"
            />
          </div>
        </div>

        <!-- FECHA RETORNO (opcional) -->
        <div class="search-field">
          <label class="field-label">
            Fecha de retorno
            <span class="field-optional">(Opcional)</span>
          </label>
          <div class="field-input-wrapper">
            <span class="field-icon">üìÖ</span>
            <input
              type="date"
              class="field-input"
              formControlName="fechaRetorno"
              [min]="minFechaRetorno"
            />
          </div>
        </div>

        <!-- BOT√ìN BUSCAR -->
        <div class="search-button-wrapper">
          <button type="submit" class="btn-search">
            üîç Buscar
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- RESULTADOS Y COMPRA -->
<div class="container mt-4">
  <!-- MENSAJES -->
  <div *ngIf="loading" class="alert alert-info">
    Buscando viajes...
  </div>

  <div *ngIf="errorMsg" class="alert alert-danger">
    {{ errorMsg }}
  </div>

  <div *ngIf="!loading && buscado && resultados.length === 0" class="alert alert-warning">
    No se encontraron viajes para esa b√∫squeda.
  </div>

  <!-- LISTA DE VIAJES EN TARJETAS -->
  <div *ngIf="!loading && resultados.length > 0" class="result-header">
    <h3>Resultados disponibles para tu b√∫squeda</h3>
  </div>

  <div class="viajes-list" *ngIf="!loading && resultados.length > 0">
    <div class="viaje-card" *ngFor="let v of resultados">
      <div class="viaje-main">
        <div class="viaje-info">
          <h5 class="viaje-ruta">
            De {{ v.origen }} a {{ v.destino }}
          </h5>
          <p class="viaje-fecha">
            Salida: <strong>{{ v.fechaSalida | date:'shortDate' }}</strong>
          </p>
          <p class="viaje-detalle">
            <span>Hora de salida: <strong>{{ v.fechaSalida | date:'HH:mm' }}</strong></span>
            <span>Hora de llegada: <strong>{{ v.fechaLlegada | date:'HH:mm' }}</strong></span>
          </p>
          <p class="viaje-detalle">
            <span>Asientos disponibles: <strong>{{ v.asientosDisponibles }}</strong></span>
            <span>Estado: <strong>{{ v.estado }}</strong></span>
          </p>
        </div>

        <div class="viaje-precio">
          <div class="precio-monto">
            S/ {{ v.precio | number:'1.2-2' }}
          </div>
          <div class="precio-label">por pasajero</div>
          <button
            class="btn-ver-asientos"
            [disabled]="v.asientosDisponibles === 0 || v.estado !== 'PROGRAMADO'"
            (click)="seleccionarViaje(v)">
            Ver asientos
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- BLOQUE DE SELECCI√ìN DE ASIENTOS + RESUMEN -->
  <div class="compra-section mt-4" *ngIf="selectedViaje">
    <h4>De {{ selectedViaje.origen }} a {{ selectedViaje.destino }}</h4>
    <p class="compra-subtitle">
      Fecha: {{ selectedViaje.fechaSalida | date:'fullDate' }} ‚Ä¢
      Salida: {{ selectedViaje.fechaSalida | date:'HH:mm' }} ‚Ä¢
      Llegada: {{ selectedViaje.fechaLlegada | date:'HH:mm' }} ‚Ä¢
      Asientos disponibles: {{ selectedViaje.asientosDisponibles }}
    </p>

    <div class="compra-layout">
      <div class="compra-left">
        <div class="seat-layout">
          <div class="seat-legend">
            <span><span class="legend-box available"></span>Disponible</span>
            <span><span class="legend-box selected"></span>Seleccionado</span>
          </div>

          <div class="seat-grid">
            <ng-container *ngFor="let seat of seatNumbers">
              <input
                #seatCheckbox
                type="checkbox"
                class="seat-input"
                [id]="'seat-' + seat"
                (change)="onSeatToggle(seat, seatCheckbox.checked)"
              />
              <label class="seat-label" [for]="'seat-' + seat">
                {{ seat }}
              </label>
            </ng-container>
          </div>
        </div>
      </div>

      <div class="compra-right">
        <div class="resumen-card">
          <h5 class="titulo-resumen">Resumen de tu reserva</h5>

          <p><strong>Empresa:</strong> Transporte Miranda</p>
          <p><strong>Origen:</strong> {{ selectedViaje.origen }}</p>
          <p><strong>Destino:</strong> {{ selectedViaje.destino }}</p>
          <p><strong>Hora de salida:</strong> {{ selectedViaje.fechaSalida | date:'HH:mm' }}</p>

          <p><strong>Asientos:</strong> {{ resumenAsientos || '-' }}</p>
          <p><strong>Cantidad:</strong> {{ cantidadAsientos }}</p>

          <p><strong>Precio por asiento:</strong> S/
            {{ selectedViaje.precio | number:'1.2-2' }}</p>
          <p><strong>Total a pagar:</strong>
            <span class="precio-total">S/ {{ totalAPagar | number:'1.2-2' }}</span>
          </p>

          <button
            type="button"
            class="btn btn-primary w-100 mt-2"
            (click)="confirmarCompra()"
            [disabled]="loading || cantidadAsientos === 0">
            Confirmar compra
          </button>

          <div *ngIf="compraMsg" class="alert alert-success mt-3">
            {{ compraMsg }}
          </div>
          <div *ngIf="compraError" class="alert alert-danger mt-3">
            {{ compraError }}
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="mostrarFormularioPasajeros" class="pasajeros-form-card mt-4">
      <h5>Datos de los pasajeros</h5>
      <form [formGroup]="pasajerosForm" (ngSubmit)="finalizarCompra()">
        <div formArrayName="pasajeros">
          <div
            class="pasajero-item"
            *ngFor="let pasajeroGroup of pasajerosArray.controls; let i = index"
            [formGroupName]="i">

            <h6>Pasajero {{ i + 1 }} - Asiento {{
              pasajeroGroup.get('asiento')?.value
            }}</h6>

            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Nombres</label>
                <input type="text" class="form-control" formControlName="nombres" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Apellidos</label>
                <input type="text" class="form-control" formControlName="apellidos" />
              </div>
              <div class="col-md-4">
                <label class="form-label">DNI</label>
                <input type="text" class="form-control" formControlName="dni" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" formControlName="email" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Celular</label>
                <input type="text" class="form-control" formControlName="celular" />
              </div>
            </div>

            <hr *ngIf="i < pasajerosArray.length - 1" />
          </div>
        </div>

        <button
          type="submit"
          class="btn btn-success w-100 mt-3"
          [disabled]="loading">
          Finalizar compra
        </button>
      </form>
    </div>
  </div>
</div>
